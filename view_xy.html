<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ğŸ« Dutch secondary school map: academic level Ã— science focus</title>
  <link rel="icon" href="data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20100%20100%22%3E%3Ctext%20y%3D%22.9em%22%20font-size%3D%2290%22%3E%F0%9F%8E%AB%3C%2Ftext%3E%3C%2Fsvg%3E">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
    tailwind.config = { darkMode: 'class', theme: { extend: { fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] } } } }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <script>document.documentElement.classList.toggle('dark', localStorage.getItem('theme')==='dark');</script>
  <style>.chartjs-tooltip { max-width: min(320px, 90vw); overflow-wrap: break-word; word-break: break-word; transform-origin: bottom center; z-index: 40; } #chartLabels { z-index: 10; } #shareWrap.open #shareDropdown, #langWrap.open #langDropdown { opacity: 1; visibility: visible; } details summary { list-style: none; } details summary::-webkit-details-marker { display: none; } .input-wrap { position: relative; } .input-hint { position: absolute; left: 0; right: 0; top: 100%; margin-top: 4px; padding: 8px 10px; font-size: 0.75rem; line-height: 1.35; color: var(--hint-text, #475569); background: var(--hint-bg, #f1f5f9); border: 1px solid var(--hint-border, #e2e8f0); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); z-index: 30; opacity: 0; visibility: hidden; transition: opacity 0.15s, visibility 0.15s; pointer-events: none; max-width: min(100%, 420px); } .input-wrap.show-hint .input-hint, .input-wrap:hover .input-hint { opacity: 1; visibility: visible; } .dark .input-hint { --hint-text: #94a3b8; --hint-bg: #334155; --hint-border: #475569; } .segmented-btn { @apply inline-flex items-center justify-center px-3 py-1.5 text-xs font-medium rounded-full border border-slate-300 dark:border-slate-600 text-slate-600 dark:text-slate-300 bg-white/80 dark:bg-slate-800/80; } .segmented-btn-active { @apply bg-slate-900 text-white dark:bg-slate-100 dark:text-slate-900 border-slate-900 dark:border-slate-100; }</style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-200 font-sans antialiased">
  <div id="wrap" class="max-w-6xl mx-auto px-[2vw] sm:px-6 py-8">
    <div class="flex flex-wrap justify-between items-center gap-4 mb-2">
      <div class="flex items-center gap-1 rounded-lg border border-slate-300 dark:border-slate-500 p-0.5">
        <button type="button" id="navVO" class="navSchoolType px-3 py-1.5 text-sm font-medium rounded-md border-0 bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-100" data-mode="vo">ä¸­å­¦</button>
        <button type="button" id="navPO" class="navSchoolType px-3 py-1.5 text-sm font-medium rounded-md border-0 bg-transparent text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700" data-mode="po">å°å­¦</button>
      </div>
      <div class="flex items-center gap-4">
      <button type="button" id="themeToggle" class="p-2 rounded-lg border border-slate-300 dark:border-slate-500 text-slate-700 dark:text-slate-300 bg-white dark:bg-slate-700 hover:bg-slate-50 dark:hover:bg-slate-600 focus:outline-none focus:ring-1 focus:ring-slate-400 inline-flex items-center justify-center" title="Theme" aria-label="Toggle theme">
        <span id="themeIcon" aria-hidden="true">
          <svg class="w-5 h-5 dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
          <svg class="w-5 h-5 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
        </span>
      </button>
      <div class="relative inline-block" id="langWrap">
        <button type="button" id="langBtn" class="inline-flex items-center gap-1 px-2.5 py-1.5 text-sm rounded-lg border border-slate-300 dark:border-slate-500 text-slate-700 dark:text-slate-300 bg-white dark:bg-slate-700 hover:bg-slate-50 dark:hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-400" title="Language" aria-label="Language" aria-haspopup="true" aria-expanded="false"><span id="langBtnFlag" class="text-lg">ğŸ‡¬ğŸ‡§</span><span id="langBtnAbbr">EN</span></button>
        <div id="langDropdown" class="absolute right-0 top-full mt-1 py-1 min-w-[5rem] bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-600 shadow-lg opacity-0 invisible transition-all z-20">
          <button type="button" class="lang-option w-full text-left inline-flex items-center gap-1.5 px-3 py-2 text-sm text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-600 border-0 bg-transparent cursor-pointer font-inherit rounded-t-lg first:rounded-t-lg last:rounded-b-lg" data-lang="en"><span class="text-lg">ğŸ‡¬ğŸ‡§</span><span>EN</span></button>
          <button type="button" class="lang-option w-full text-left inline-flex items-center gap-1.5 px-3 py-2 text-sm text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-600 border-0 bg-transparent cursor-pointer font-inherit" data-lang="zh"><span class="text-lg">ğŸ‡¨ğŸ‡³</span><span>CHN</span></button>
          <button type="button" class="lang-option w-full text-left inline-flex items-center gap-1.5 px-3 py-2 text-sm text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-600 border-0 bg-transparent cursor-pointer font-inherit rounded-b-lg" data-lang="nl"><span class="text-lg">ğŸ‡³ğŸ‡±</span><span>NL</span></button>
        </div>
      </div>
      <div class="relative inline-block group" id="shareWrap">
        <button type="button" id="shareBtn" class="inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium rounded-lg border border-slate-300 dark:border-slate-500 text-slate-700 dark:text-slate-300 bg-white dark:bg-slate-700 hover:bg-slate-50 dark:hover:bg-slate-600">Share</button>
        <div id="shareDropdown" class="absolute right-0 top-full mt-1 py-1 min-w-[10rem] bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-600 shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-20">
          <button type="button" id="shareCopyLink" class="w-full text-left px-3 py-2 text-sm text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-600 rounded-t-lg border-0 bg-transparent cursor-pointer font-inherit">Copy link</button>
          <button type="button" id="shareDownloadPicture" class="w-full text-left px-3 py-2 text-sm text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-600 border-0 bg-transparent cursor-pointer font-inherit">Download picture</button>
          <a href="#" id="shareXLink" target="_blank" rel="noopener noreferrer" class="block px-3 py-2 text-sm text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-600 no-underline">Share to X</a>
          <a href="#" id="shareFbLink" target="_blank" rel="noopener noreferrer" class="block px-3 py-2 text-sm text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-600 no-underline rounded-b-lg">Share to Facebook</a>
        </div>
      </div>
      </div>
    </div>
    <div id="mobileControls" class="md:hidden mb-4 space-y-3">
      <div class="flex flex-col gap-1">
        <label for="mobileSchoolSearch" class="text-xs font-medium text-slate-600 dark:text-slate-400">School search</label>
        <input type="text" id="mobileSchoolSearch" placeholder="Name or acronym" class="w-full rounded-lg border border-slate-300 dark:border-slate-500 px-3 py-1.5 text-sm text-slate-800 dark:text-slate-200 dark:bg-slate-800 placeholder-slate-400 dark:placeholder-slate-500 focus:border-slate-400 focus:outline-none focus:ring-1 focus:ring-slate-400">
      </div>
      <div class="flex items-center justify-between gap-3">
        <button type="button" id="mobileSboToggle" class="hidden items-center gap-1.5 px-3 py-1.5 text-xs font-medium rounded-full border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-200 bg-white/80 dark:bg-slate-800/80" aria-pressed="false">
          <span class="inline-block w-2 h-2 rounded-full bg-emerald-500/80"></span>
          <span id="mobileSboLabel">Sbo</span>
        </button>
      </div>
    </div>
    <div id="chartWrap" class="mb-8">
      <h1 id="titleMain" class="text-xl font-semibold text-slate-800 dark:text-slate-100 tracking-tight"><a href="/" class="text-slate-800 dark:text-slate-100 hover:text-slate-600 dark:hover:text-slate-300">ğŸ« Dutch secondary school map</a>: academic level Ã— science focus</h1>
      <p id="subtitleMain" class="mt-1 text-sm text-slate-500 dark:text-slate-400">Data from DUO (excluding international schools). X = academic strength, Y = science share. Dot size = graduation count. <strong id="schoolCount" class="font-medium text-slate-700 dark:text-slate-300">0</strong> schools shown.</p>
      <div class="mt-4 bg-white dark:bg-slate-800 rounded-xl border border-slate-200/80 dark:border-slate-600 shadow-sm p-[2vw] sm:p-6">
        <div class="w-full aspect-[4/3] min-h-[55vh] sm:min-h-[420px] relative">
          <canvas id="chart" class="w-full h-full block"></canvas>
          <div id="chartLabels" class="absolute inset-0 pointer-events-none overflow-hidden" style="left:0;top:0;right:0;bottom:0;"></div>
        </div>
        <div id="customLegend" class="flex flex-wrap justify-center gap-x-6 gap-y-2 mt-3 pt-3 border-t border-slate-200 dark:border-slate-600" style="min-height: 24px;"></div>
      </div>
    </div>
    <div class="controls hidden md:flex flex-wrap items-center gap-4 sm:gap-6 py-4 px-[2vw] sm:px-4 bg-white dark:bg-slate-800 rounded-xl border border-slate-200/80 dark:border-slate-600 shadow-sm">
      <div id="schoolSearchWrap" class="input-wrap flex items-center gap-2 flex-1 min-w-[200px] basis-[200px]">
        <label id="labelSchoolSearch" class="text-sm font-medium text-slate-600 dark:text-slate-400 whitespace-nowrap">School search</label>
        <input type="text" id="schoolSearch" placeholder="Name or acronym (e.g. HWC)" class="flex-1 min-w-[120px] rounded-lg border border-slate-300 dark:border-slate-500 px-3 py-2 text-sm text-slate-800 dark:text-slate-200 dark:bg-slate-700 placeholder-slate-400 dark:placeholder-slate-500 focus:border-slate-400 focus:outline-none focus:ring-1 focus:ring-slate-400" title="">
        <div id="schoolSearchHint" class="input-hint" role="tooltip" aria-live="polite"></div>
      </div>
      <div id="gemeenteFilterWrap" class="input-wrap flex items-center gap-2 flex-1 min-w-[200px] basis-[200px]">
        <label id="labelGemeente" class="text-sm font-medium text-slate-600 dark:text-slate-400 whitespace-nowrap">City hall filter</label>
        <input type="text" id="gemeenteFilter" placeholder="Empty = all, comma for multiple" class="flex-1 min-w-[120px] rounded-lg border border-slate-300 dark:border-slate-500 px-3 py-2 text-sm text-slate-800 dark:text-slate-200 dark:bg-slate-700 placeholder-slate-400 dark:placeholder-slate-500 focus:border-slate-400 focus:outline-none focus:ring-1 focus:ring-slate-400" title="">
        <div id="gemeenteFilterHint" class="input-hint" role="tooltip" aria-live="polite"></div>
      </div>
      <div class="flex flex-wrap items-center gap-4">
        <label class="inline-flex items-center gap-2 cursor-pointer text-sm text-slate-600 dark:text-slate-400">
          <input type="checkbox" id="showVMBO" class="rounded border-slate-300 text-slate-600 focus:ring-slate-400">
          <span id="labelShowVMBO">Include VMBO-only schools</span>
        </label>
      </div>
    </div>
    <div id="gemeenteList" class="mt-8 pt-6 border-t border-slate-200 dark:border-slate-600">
      <div class="gemeente-list-header flex flex-wrap items-center gap-4 mb-3">
        <label class="inline-flex items-center gap-2 cursor-pointer text-sm font-medium text-slate-600 dark:text-slate-400">
          <input type="checkbox" id="selectAll" class="rounded border-slate-300 text-slate-600 focus:ring-slate-400">
          <span id="labelSelectAll">Select all</span>
        </label>
        <label class="inline-flex items-center gap-2 cursor-pointer text-sm font-medium text-slate-600 dark:text-slate-400">
          <input type="checkbox" id="deselectAll" class="rounded border-slate-300 text-slate-600 focus:ring-slate-400">
          <span id="labelDeselectAll">Deselect all</span>
        </label>
      </div>
      <div id="gemeenteCheckboxes" class="max-h-56 overflow-y-auto flex flex-wrap gap-x-4 gap-y-2"></div>
    </div>
    <button type="button" id="mobileFiltersBtn" class="fixed md:hidden right-4 bottom-4 z-30 inline-flex items-center gap-2 px-3 py-2 rounded-full bg-slate-900 text-white text-xs font-medium shadow-lg border border-slate-700">
      <span>Filters</span>
      <span id="mobileFiltersBtnLabel" class="opacity-80">Cities (0)</span>
    </button>
    <div id="mobileFiltersSheet" class="fixed inset-0 z-40 md:hidden pointer-events-none">
      <div id="mobileFiltersBackdrop" class="absolute inset-0 bg-slate-900/40 opacity-0 transition-opacity"></div>
      <div id="mobileFiltersPanel" class="absolute inset-x-0 bottom-0 translate-y-full transition-transform">
        <div class="mx-auto max-w-6xl px-4 pb-4">
          <div class="bg-white dark:bg-slate-900 rounded-t-2xl shadow-xl border border-slate-200 dark:border-slate-700 max-h-[70vh] overflow-hidden">
            <div class="flex items-center justify-between px-4 pt-3 pb-2 border-b border-slate-200 dark:border-slate-700">
              <p id="mobileFiltersHeader" class="text-xs font-medium text-slate-700 dark:text-slate-200">Cities (0)</p>
              <button type="button" id="mobileFiltersClose" class="text-xs text-slate-500 dark:text-slate-400 px-2 py-1">Close</button>
            </div>
            <div id="mobileFiltersContent" class="px-4 py-2">
              <!-- å°†ç°æœ‰çš„ #gemeenteList åœ¨ JS ä¸­ç§»åŠ¨åˆ°è¿™é‡Œ -->
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="excludedSection" class="mt-8 pt-6 border-t border-slate-200 dark:border-slate-600 text-sm text-slate-500 dark:text-slate-400"></div>
    <div id="algorithmSection" class="mt-8 pt-6 border-t border-slate-200 dark:border-slate-600 text-sm text-slate-600 dark:text-slate-400">
      <details class="group/details">
        <summary id="algorithmTitle" class="text-base font-semibold text-slate-700 dark:text-slate-300 cursor-pointer list-none flex items-center gap-2 [&::-webkit-details-marker]:hidden">
          <span class="collapsible-arrow transition-transform group-open/details:rotate-90 origin-center">â–¶</span>
          <span id="algorithmTitleText"></span>
        </summary>
        <div id="algorithmBody" class="mt-3 space-y-2 prose prose-slate max-w-none text-sm"></div>
      </details>
    </div>
    <div id="disclaimerSection" class="mt-6 pt-4 border-t border-slate-200 dark:border-slate-600 text-sm text-slate-500 dark:text-slate-400">
      <details class="group/details">
        <summary id="disclaimerTitle" class="text-base font-semibold text-slate-700 dark:text-slate-300 cursor-pointer list-none flex items-center gap-2 [&::-webkit-details-marker]:hidden">
          <span class="collapsible-arrow transition-transform group-open/details:rotate-90 origin-center">â–¶</span>
          <span id="disclaimerTitleText"></span>
        </summary>
        <p id="disclaimerBody" class="mt-2 text-slate-500 dark:text-slate-400"></p>
      </details>
    </div>
    <div id="contactSection" class="mt-6 pt-4 border-t border-slate-200 dark:border-slate-600 text-sm text-slate-500 dark:text-slate-400 pb-4">
      <h2 id="contactTitle" class="text-base font-semibold text-slate-700 dark:text-slate-300 mb-2"></h2>
      <p class="text-slate-600 dark:text-slate-400">
        <a href="mailto:dewei.zhai@gmail.com" class="text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 underline">dewei.zhai@gmail.com</a>
        &nbsp;Â·&nbsp;
        <a href="https://www.linkedin.com/in/zhaidewei/" target="_blank" rel="noopener noreferrer" class="text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 underline">LinkedIn</a>
      </p>
    </div>
    <div id="supportSection" class="mt-4 pt-4 border-t border-slate-200 dark:border-slate-600 text-sm pb-4">
      <p class="text-slate-600 dark:text-slate-400 mb-2">
        <a id="supportLink" href="https://ko-fi.com/deweizhai" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 rounded-lg bg-amber-500/90 hover:bg-amber-500 px-4 py-2 text-sm font-medium text-white no-underline shadow-sm">Ko-fi</a>
      </p>
      <p id="supportHint" class="text-slate-500 dark:text-slate-400 text-xs"></p>
    </div>
    <footer id="copyrightSection" class="mt-4 pt-4 border-t border-slate-200 dark:border-slate-600 text-xs text-slate-400 dark:text-slate-500 pb-8">
      <p id="copyrightText"></p>
    </footer>
  </div>
  <script>
    const dataVO = __INJECT_DATA_VO__;
    const dataPO = __INJECT_DATA_PO__;
    const excludedVO = __INJECT_EXCLUDED_VO__;
    const excludedPO = __INJECT_EXCLUDED_PO__;
    // demo / schema æ¨¡å¼ä¸‹ï¼Œåç«¯ä¼šæ³¨å…¥ metaVO / metaPOï¼ˆéµå®ˆ refactor/SCHEMA.mdï¼‰
    // é demo æ¨¡å¼ä¸‹ï¼Œè¿™é‡Œæ˜¯ {}ï¼Œåç»­å‰ç«¯å¯ä»¥æ¸è¿›å¼æ¥å…¥ã€‚
    const metaVO = __INJECT_META_VO__;
    const metaPO = __INJECT_META_PO__;
    let currentMode = localStorage.getItem('schools-mode') || 'vo';
    let data = currentMode === 'vo' ? dataVO : dataPO;
    let excluded = currentMode === 'vo' ? excludedVO : excludedPO;
    let meta = currentMode === 'vo' ? metaVO : metaPO;

    function resolveMetricFromMeta(metricId) {
      if (!meta || !metricId || !meta.i18n || typeof meta.i18n !== 'object') return null;
      var tried = new Set();
      var order = [];
      if (currentLang && meta.i18n[currentLang]) {
        order.push(currentLang);
        tried.add(currentLang);
      }
      if (meta.i18n.en && !tried.has('en')) {
        order.push('en');
        tried.add('en');
      }
      Object.keys(meta.i18n).forEach(function (code) {
        if (!tried.has(code)) {
          order.push(code);
          tried.add(code);
        }
      });
      for (var i = 0; i < order.length; i++) {
        var code = order[i];
        var loc = meta.i18n[code];
        if (!loc || !loc.metrics) continue;
        var metric = loc.metrics[metricId];
        if (metric) return metric;
      }
      return null;
    }

    function getAxisTitleFromMeta(axisKey) {
      if (!meta || !meta.axes || !meta.i18n) return null;
      var axesCfg = meta.axes[axisKey];
      if (!axesCfg || !axesCfg.metric_id) return null;
      var metricId = axesCfg.metric_id;
      var metric = resolveMetricFromMeta(metricId);
      return metric && metric.label ? metric.label : null;
    }

    function buildAlgorithmBodyFromMeta() {
      if (!meta || !meta.axes || !meta.i18n) return null;
      var axes = meta.axes;
      var parts = [];
      if (axes.x && axes.x.metric_id) {
        var mx = resolveMetricFromMeta(axes.x.metric_id);
        if (mx && (mx.label || mx.description)) {
          parts.push(
            '<p><strong>X axis â€“ ' +
            (mx.label || axes.x.metric_id) +
            '</strong><br>' +
            (mx.description || '') +
            '</p>'
          );
        }
      }
      if (axes.y && axes.y.metric_id) {
        var my = resolveMetricFromMeta(axes.y.metric_id);
        if (my && (my.label || my.description)) {
          parts.push(
            '<p><strong>Y axis â€“ ' +
            (my.label || axes.y.metric_id) +
            '</strong><br>' +
            (my.description || '') +
            '</p>'
          );
        }
      }
      if (axes.size && axes.size.metric_id) {
        var ms = resolveMetricFromMeta(axes.size.metric_id);
        if (ms && (ms.label || ms.description)) {
          parts.push(
            '<p><strong>Dot size â€“ ' +
            (ms.label || axes.size.metric_id) +
            '</strong><br>' +
            (ms.description || '') +
            '</p>'
          );
        }
      }
      if (!parts.length) return null;
      return parts.join('');
    }
    function updateExcludedSection() {
      excluded = currentMode === 'vo' ? excludedVO : excludedPO;
      const el = document.getElementById('excludedSection');
      if (!el) return;
      if (excluded.length === 0) { el.innerHTML = ''; return; }
      el.innerHTML = '<details class="group/details"><summary id="excludedTitle" class="text-base font-semibold text-slate-700 dark:text-slate-300 cursor-pointer list-none flex items-center gap-2 [&::-webkit-details-marker]:hidden"><span class="collapsible-arrow transition-transform group-open/details:rotate-90 origin-center">â–¶</span><span id="excludedTitleText"></span></summary><div class="mt-2"><p id="excludedDesc" class="mb-3 text-slate-500 dark:text-slate-400"></p><ul class="list-disc pl-5 max-h-44 overflow-y-auto space-y-1 text-slate-600 dark:text-slate-400">' +
        excluded.map(function(s) { return '<li>' + (s.BRIN || '') + ' ' + (s.naam || '') + ' (' + (s.gemeente || '') + ')</li>'; }).join('') + '</ul></div></details>';
      var excludedTitleText = document.getElementById('excludedTitleText');
      if (excludedTitleText) excludedTitleText.textContent = t('excludedTitle');
      var excludedDesc = document.getElementById('excludedDesc');
      if (excludedDesc) excludedDesc.textContent = t('excludedDesc');
    }
  </script>
  <script>
    // ç®€å•å‰ç«¯ build æ ‡è®°ï¼Œä¾¿äºç¡®è®¤æ˜¯å¦åŠ è½½äº†æœ€æ–°ç‰ˆæœ¬
    window.__VIEW_XY_BUILD_ID__ = '2026-02-10-linear-only';
    console.log('[view_xy] build', window.__VIEW_XY_BUILD_ID__);
    let currentLang = localStorage.getItem('schools-lang') || 'en';
    const L = {
      en: {
        navVO: 'Secondary',
        navPO: 'Primary',
        labelLanguage: 'Language',
        labelTheme: 'Theme',
        share: 'Share',
        shareCopyLink: 'Copy link',
        shareCopied: 'Copied!',
        shareDownloadPicture: 'Download picture',
        shareDownloading: 'Generatingâ€¦',
        shareToX: 'Share to X',
        shareToFacebook: 'Share to Facebook',
        labelLight: 'Light',
        labelDark: 'Dark',
        titleMain: 'ğŸ« Dutch secondary school map: academic level Ã— science focus',
        subtitleBefore: 'Data from DUO (excluding international schools). X = academic strength, Y = science share. Dot size = graduation count. ',
        subtitleAfter: ' schools shown.',
        labelSchoolSearch: 'School search',
        schoolSearchPlaceholder: 'Search by name or acronym (e.g. HWC), comma for multiple, partial match highlighted',
        schoolSearchPlaceholderShort: 'Name or acronym (e.g. HWC)',
        labelGemeente: 'City hall filter',
        gemeentePlaceholder: 'Leave empty for all, comma for multiple',
        gemeentePlaceholderShort: 'Empty = all, comma for multiple',
        labelShowVMBO: 'Include VMBO-only schools',
        labelSelectAll: 'Select all',
        labelDeselectAll: 'Deselect all',
        excludedTitle: 'Schools excluded (too few data points)',
        excludedDesc: 'The following schools were not included in the chart because HAVO/VWO exam candidates (5-year total) are below 20.',
        axisXLinear: 'VWO share (%) â€” 100% most academic',
        axisYLinear: 'Science share (%)',
        tooltipCandidates: '5-yr candidates',
        tooltipPostcode: 'Postcode',
        algorithmTitle: 'How X and Y are calculated',
        algorithmBody: '<p><strong>X (horizontal):</strong> VWO share = VWO passed / total exam candidates (all tracks: HAVO, VWO, VMBO) at the school, as a percentage (0â€“100%). Higher X means more academically oriented (more VWO).</p><p><strong>Y (vertical):</strong> Science share = science passed / total exam candidates. For HAVO/VWO schools, science = the following profiles (bÃ¨ta):</p><ul class="list-disc pl-5 my-1"><li><strong>N&amp;T</strong> â€” Natuur &amp; Techniek (Nature &amp; Technology): maths, physics, chemistry, technical subjects.</li><li><strong>N&amp;G</strong> â€” Natuur &amp; Gezondheid (Nature &amp; Health): biology, chemistry, health-related subjects.</li><li><strong>N&amp;T/N&amp;G</strong> â€” combination profile of N&amp;T and N&amp;G.</li></ul><p>For VMBO-only schools, Y = techniek share within VMBO, and X is set to 0.</p><p>Both X and Y are <strong>weighted averages</strong> over school years 2019â€“2020 to 2023â€“2024, with recent years weighted more. Dot size = graduation count (5-year sum) at the school.</p>',
        disclaimerTitle: 'Disclaimer',
        disclaimerBody: 'Data from DUO Open Onderwijsdata (exam candidates and pass counts). This tool is for reference only; no warranty of accuracy or fitness for any decision. Not affiliated with DUO or the Dutch government.',
        contactTitle: 'Contact',
        supportHint: 'Like this tool? Buy me a coffee on Ko-fi.',
        copyrightText: 'Â© 2025 Dewei Zhai. This project is licensed under the MIT License.',
        titleMain_po: 'ğŸ« Dutch primary school map: VWO-advice share Ã— WOZ (postcode)',
        subtitleBefore_po: 'Data from DUO schooladviezen + CBS WOZ. X = VWO-advice share (%), Y = mean WOZ (Ã—1000 â‚¬). Dot size = pupils. ',
        axisXLinear_po: 'VWO-advice share (%)',
        axisYLinear_po: 'Mean WOZ (Ã—1000 â‚¬)',
        labelShowSbo: 'Include Sbo-only schools',
        excludedTitle_po: 'Primary schools excluded (too few pupils)',
        excludedDesc_po: 'The following schools were not included because total advised pupils (across years) are below the threshold.',
        algorithmTitle_po: 'How X and Y are calculated (primary)',
        algorithmBody_po: '<p><strong>X (horizontal):</strong> VWO-advice share = (VWO + 0.5Ã—HAVO_VWO + 0.1Ã—HAVO) / total advised pupils, as a percentage. Higher X = more pupils advised to academic tracks.</p><p><strong>Y (vertical):</strong> Mean WOZ = average WOZ value of dwellings (Ã—1000 â‚¬) for the school postcode (PC4), from CBS, weighted by year.</p><p>Dot size = total advised pupils.</p><p><strong>WOZ data:</strong> CBS publishes WOZ by postcode for <strong>2021, 2022 and 2023</strong> only. For school years that map to 2019 or 2020 we use the nearest available year (e.g. 2021). If a postcode has no WOZ in CBS, Y is shown as 0.</p>',
        tooltipCandidates_po: 'pupils (advised)'
      },
      zh: {
        navVO: 'ä¸­å­¦',
        navPO: 'å°å­¦',
        labelLanguage: 'è¯­è¨€',
        labelTheme: 'ä¸»é¢˜',
        share: 'åˆ†äº«',
        shareCopyLink: 'å¤åˆ¶é“¾æ¥',
        shareCopied: 'å·²å¤åˆ¶',
        shareDownloadPicture: 'ä¸‹è½½å›¾ç‰‡',
        shareDownloading: 'ç”Ÿæˆä¸­â€¦',
        shareToX: 'åˆ†äº«åˆ° X',
        shareToFacebook: 'åˆ†äº«åˆ° Facebook',
        labelLight: 'æµ…è‰²',
        labelDark: 'æ·±è‰²',
        titleMain: 'ğŸ« è·å…°ä¸­å­¦å®šä½å›¾ï¼šå­¦æœ¯åº¦ Ã— ç†ç§‘åº¦',
        subtitleBefore: 'æ•°æ®æ¥è‡ªDUOï¼ˆä¸å«å›½é™…å­¦æ ¡ï¼‰ï¼ŒXè½´ä»£è¡¨å­¦æœ¯å¼ºåº¦ï¼ŒYè½´ä»£è¡¨ç†ç§‘å æ¯”ï¼Œç‚¹çš„å¤§å°ä»£è¡¨æ¯•ä¸šäººæ•°ã€‚å…± ',
        subtitleAfter: ' æ‰€å­¦æ ¡ã€‚',
        labelSchoolSearch: 'å­¦æ ¡æœç´¢',
        schoolSearchPlaceholder: 'æŒ‰æ ¡åæˆ–é¦–å­—æ¯ç¼©å†™ï¼ˆå¦‚ HWCï¼‰æœç´¢ï¼Œé€—å·åˆ†éš”å¤šä¸ªï¼Œéƒ¨åˆ†åŒ¹é…é«˜äº®',
        schoolSearchPlaceholderShort: 'æ ¡åæˆ–ç¼©å†™ï¼ˆå¦‚ HWCï¼‰',
        labelGemeente: 'å¸‚æ”¿å… è¿‡æ»¤',
        gemeentePlaceholder: 'ä¸è¾“å…¥æ˜¾ç¤ºå…¨éƒ¨ï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”',
        gemeentePlaceholderShort: 'ç©º=å…¨éƒ¨ï¼Œé€—å·åˆ†éš”',
        labelShowVMBO: 'åŒ…æ‹¬çº¯ VMBO å­¦æ ¡',
        labelSelectAll: 'å…¨é€‰',
        labelDeselectAll: 'å…¨éƒ¨å–æ¶ˆ',
        excludedTitle: 'å› æ•°æ®ç‚¹è¿‡å°‘æœªçº³å…¥å›¾è¡¨çš„å­¦æ ¡',
        excludedDesc: 'ä»¥ä¸‹å­¦æ ¡å›  HAVO/VWO è€ƒç”Ÿæ•°è¿‡å°‘ï¼ˆ5 å¹´åˆè®¡ < 20ï¼‰æœªå‚ä¸åæ ‡è®¡ç®—ï¼Œæ•…æœªå‡ºç°åœ¨ä¸Šå›¾ä¸­ã€‚',
        axisXLinear: 'VWO é€šè¿‡äººæ•°å æ¯” (%) â€” 100% å­¦æœ¯æ€§æœ€å¼º',
        axisYLinear: 'ç†ç§‘å æ¯” (%)',
        tooltipCandidates: '5å¹´è€ƒç”Ÿ',
        tooltipPostcode: 'é‚®ç¼–',
        algorithmTitle: 'X ä¸ Y çš„è®¡ç®—æ–¹å¼',
        algorithmBody: '<p><strong>Xï¼ˆæ¨ªè½´ï¼‰ï¼š</strong>VWO é€šè¿‡äººæ•°å æ¯” = è¯¥æ ¡ VWO é€šè¿‡äººæ•° / è¯¥æ ¡å…¨éƒ¨è€ƒç”Ÿæ€»æ•°ï¼ˆHAVOã€VWOã€VMBO ç­‰ï¼‰ï¼Œä»¥ç™¾åˆ†æ¯”è¡¨ç¤ºï¼ˆ0â€“100%ï¼‰ã€‚X è¶Šé«˜è¡¨ç¤ºè¶Šåå­¦æœ¯ï¼ˆVWO è¶Šå¤šï¼‰ã€‚</p><p><strong>Yï¼ˆçºµè½´ï¼‰ï¼š</strong>ç†ç§‘é€šè¿‡äººæ•°å æ¯” = ç†ç§‘é€šè¿‡äººæ•° / è¯¥æ ¡å…¨éƒ¨è€ƒç”Ÿæ€»æ•°ã€‚HAVO/VWO å­¦æ ¡çš„ç†ç§‘æŒ‡ä»¥ä¸‹æ–¹å‘ï¼ˆbÃ¨taï¼‰ï¼š</p><ul class="list-disc pl-5 my-1"><li><strong>N&amp;T</strong> â€” Natuur &amp; Techniekï¼ˆè‡ªç„¶ä¸æŠ€æœ¯ï¼‰ï¼šæ•°å­¦ã€ç‰©ç†ã€åŒ–å­¦ã€æŠ€æœ¯ç­‰ã€‚</li><li><strong>N&amp;G</strong> â€” Natuur &amp; Gezondheidï¼ˆè‡ªç„¶ä¸å¥åº·ï¼‰ï¼šç”Ÿç‰©ã€åŒ–å­¦ã€å¥åº·ç›¸å…³ç­‰ã€‚</li><li><strong>N&amp;T/N&amp;G</strong> â€” N&amp;T ä¸ N&amp;G çš„ç»„åˆæ–¹å‘ã€‚</li></ul><p>ä»… VMBO çš„å­¦æ ¡ Y ä¸º VMBO å†… techniek å æ¯”ï¼ŒX å›ºå®šä¸º 0ã€‚</p><p>Xã€Y å‡ä¸º 2019â€“2020 è‡³ 2023â€“2024 å­¦å¹´çš„<strong>åŠ æƒå¹³å‡</strong>ï¼Œè¿‘å¹´æƒé‡æ›´å¤§ã€‚åœ†ç‚¹å¤§å°è¡¨ç¤ºè¯¥æ ¡ 5 å¹´æ¯•ä¸šäººæ•°ã€‚</p>',
        disclaimerTitle: 'å…è´£å£°æ˜',
        disclaimerBody: 'æ•°æ®æ¥è‡ª DUO Open Onderwijsdataï¼ˆè€ƒè¯•è€ƒç”Ÿä¸é€šè¿‡äººæ•°ï¼‰ã€‚æœ¬å·¥å…·ä»…ä¾›å‚è€ƒï¼Œä¸ä¿è¯å‡†ç¡®æˆ–é€‚ç”¨äºä»»ä½•å†³ç­–ï¼›ä¸ DUO åŠè·å…°æ”¿åºœæ— å…³è”ã€‚',
        contactTitle: 'è”ç³»ä½œè€…',
        supportHint: 'è§‰å¾—æœ‰ç”¨ï¼Ÿè¯·åœ¨ Ko-fi è¯·æˆ‘å–æ¯å’–å•¡ã€‚',
        copyrightText: 'Â© 2025 ç¿Ÿå¾·ç‚œã€‚æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ã€‚',
        titleMain_po: 'ğŸ« è·å…°å°å­¦å®šä½å›¾ï¼šVWO å‡å­¦ç‡ Ã— é‚®ç¼– WOZ',
        subtitleBefore_po: 'æ•°æ®æ¥è‡ª DUO æ¯•ä¸šå»ºè®® + CBS WOZã€‚X = VWO å‡å­¦ç‡(%)ï¼ŒY = é‚®ç¼– WOZ å‡å€¼(åƒæ¬§)ï¼Œç‚¹å¤§å° = äººæ•°ã€‚å…± ',
        axisXLinear_po: 'VWO å‡å­¦ç‡ (%)',
        axisYLinear_po: 'WOZ å‡å€¼ (åƒæ¬§)',
        labelShowSbo: 'åŒ…æ‹¬çº¯ Sbo å­¦æ ¡',
        excludedTitle_po: 'å› äººæ•°è¿‡å°‘æœªçº³å…¥çš„å°å­¦',
        excludedDesc_po: 'ä»¥ä¸‹å­¦æ ¡å› å»ºè®®äººæ•°åˆè®¡ä½äºé˜ˆå€¼æœªå‚ä¸å›¾è¡¨ã€‚',
        algorithmTitle_po: 'X ä¸ Y çš„è®¡ç®—æ–¹å¼ï¼ˆå°å­¦ï¼‰',
        algorithmBody_po: '<p><strong>Xï¼ˆæ¨ªè½´ï¼‰ï¼š</strong>VWO å‡å­¦ç‡ = (VWO + 0.5Ã—HAVO_VWO + 0.1Ã—HAVO) / æ€»å»ºè®®äººæ•°ï¼Œç™¾åˆ†æ¯”ã€‚X è¶Šé«˜è¡¨ç¤ºå‡å­¦æœ¯å‘è¶Šå¤šã€‚</p><p><strong>Yï¼ˆçºµè½´ï¼‰ï¼š</strong>å­¦æ ¡é‚®ç¼–(PC4)å¯¹åº”çš„ CBS WOZ å‡å€¼ï¼ˆåƒæ¬§ï¼‰ï¼ŒæŒ‰å¹´åŠ æƒã€‚</p><p>ç‚¹å¤§å° = å»ºè®®äººæ•°åˆè®¡ã€‚</p><p><strong>WOZ æ•°æ®è¯´æ˜ï¼š</strong>CBS æŒ‰é‚®ç¼–å…¬å¸ƒçš„ WOZ ä»…æœ‰ <strong>2021ã€2022ã€2023</strong> å¹´ã€‚å¯¹åº”åˆ° 2019 æˆ– 2020 å­¦å¹´æ—¶ï¼Œé‡‡ç”¨æœ€è¿‘å¯ç”¨å¹´ä»½ï¼ˆå¦‚ 2021ï¼‰çš„ WOZï¼›è‹¥æŸé‚®ç¼–åœ¨ CBS ä¸­æ—  WOZï¼Œåˆ™ Y æ˜¾ç¤ºä¸º 0ã€‚</p>',
        tooltipCandidates_po: 'äººæ•°(å»ºè®®)'
      },
      nl: {
        navVO: 'Voortgezet',
        navPO: 'Primair',
        labelLanguage: 'Taal',
        labelTheme: 'Thema',
        share: 'Delen',
        shareCopyLink: 'Link kopiÃ«ren',
        shareCopied: 'Gekopieerd!',
        shareDownloadPicture: 'Afbeelding downloaden',
        shareDownloading: 'Bezigâ€¦',
        shareToX: 'Delen op X',
        shareToFacebook: 'Delen op Facebook',
        labelLight: 'Licht',
        labelDark: 'Donker',
        titleMain: 'ğŸ« Nederlandse schoolkaart voortgezet onderwijs: academisch Ã— bÃ¨ta',
        subtitleBefore: 'Data van DUO (zonder internationale scholen). X = academisch niveau, Y = bÃ¨tandeel. Puntgrootte = aantal geslaagden. ',
        subtitleAfter: ' scholen getoond.',
        labelSchoolSearch: 'Zoek school',
        schoolSearchPlaceholder: 'Zoek op naam of afkorting (bijv. HWC), komma voor meerdere, deelmatch gemarkeerd',
        schoolSearchPlaceholderShort: 'Naam of afkorting (bijv. HWC)',
        labelGemeente: 'Gemeentefilter',
        gemeentePlaceholder: 'Leeg = alle, komma voor meerdere',
        gemeentePlaceholderShort: 'Leeg = alle, komma voor meerdere',
        labelShowVMBO: 'Inclusief alleen VMBO-scholen',
        labelSelectAll: 'Alles selecteren',
        labelDeselectAll: 'Alles deselecteren',
        excludedTitle: 'Scholen uitgesloten (te weinig datapunten)',
        excludedDesc: 'De volgende scholen zijn niet in de grafiek opgenomen omdat HAVO/VWO-examenkandidaten (5-jaar totaal) onder 20 liggen.',
        axisXLinear: 'VWO-aandeel (%) â€” 100% meest academisch',
        axisYLinear: 'BÃ¨tandeel (%)',
        tooltipCandidates: '5-jaar kandidaten',
        tooltipPostcode: 'Postcode',
        algorithmTitle: 'Hoe X en Y worden berekend',
        algorithmBody: '<p><strong>X (horizontaal):</strong> VWO-aandeel = VWO geslaagden / totaal examenkandidaten (alle richtingen: HAVO, VWO, VMBO) van de school, in procent (0â€“100%). Hogere X = meer academisch (meer VWO).</p><p><strong>Y (verticaal):</strong> BÃ¨tandeel = bÃ¨tageslaagden / totaal examenkandidaten. Voor HAVO/VWO-scholen is bÃ¨ta de volgende profielen:</p><ul class="list-disc pl-5 my-1"><li><strong>N&amp;T</strong> â€” Natuur &amp; Techniek: wiskunde, natuurkunde, scheikunde, technische vakken.</li><li><strong>N&amp;G</strong> â€” Natuur &amp; Gezondheid: biologie, scheikunde, gezondheidsgerelateerde vakken.</li><li><strong>N&amp;T/N&amp;G</strong> â€” combinatieprofiel van N&amp;T en N&amp;G.</li></ul><p>Voor alleen VMBO-scholen is Y het techniekaandeel binnen VMBO en X = 0.</p><p>X en Y zijn <strong>gewogen gemiddelden</strong> over schooljaren 2019â€“2020 t/m 2023â€“2024, met zwaardere weging voor recente jaren. Puntgrootte = aantal geslaagden (5-jaar som) van de school.</p>',
        disclaimerTitle: 'Disclaimer',
        disclaimerBody: 'Data van DUO Open Onderwijsdata (examenkandidaten en geslaagden). Dit hulpmiddel is alleen voor referentie; geen garantie op juistheid of geschiktheid voor beslissingen. Niet gelieerd aan DUO of de overheid.',
        contactTitle: 'Contact',
        supportHint: 'Waardevol? Trakteer me op een koffie via Ko-fi.',
        copyrightText: 'Â© 2025 Dewei Zhai. Dit project valt onder de MIT-licentie.',
        titleMain_po: 'ğŸ« Nederlandse basisschoolkaart: VWO-adviesaandeel Ã— WOZ (postcode)',
        subtitleBefore_po: 'Data van DUO schooladviezen + CBS WOZ. X = VWO-adviesaandeel (%), Y = gem. WOZ (Ã—1000 â‚¬). Puntgrootte = leerlingen. ',
        axisXLinear_po: 'VWO-adviesaandeel (%)',
        axisYLinear_po: 'Gem. WOZ (Ã—1000 â‚¬)',
        labelShowSbo: 'Inclusief alleen Sbo-scholen',
        excludedTitle_po: 'Basisscholen uitgesloten (te weinig leerlingen)',
        excludedDesc_po: 'De volgende scholen zijn niet opgenomen omdat het totaal geadviseerde leerlingen onder de drempel ligt.',
        algorithmTitle_po: 'Hoe X en Y worden berekend (primair)',
        algorithmBody_po: '<p><strong>X (horizontaal):</strong> VWO-adviesaandeel = (VWO + 0,5Ã—HAVO_VWO + 0,1Ã—HAVO) / totaal geadviseerde leerlingen, in procent. Hogere X = meer advies naar academische richting.</p><p><strong>Y (verticaal):</strong> Gemiddelde WOZ-waarde woningen (Ã—1000 â‚¬) voor de postcode (PC4) van de school, CBS, gewogen naar jaar.</p><p>Puntgrootte = totaal geadviseerde leerlingen.</p><p><strong>WOZ-data:</strong> CBS publiceert WOZ per postcode alleen voor <strong>2021, 2022 en 2023</strong>. Voor schooljaren die op 2019 of 2020 vallen gebruiken we het dichtstbijzijnde beschikbare jaar (bijv. 2021). Als een postcode geen WOZ heeft in CBS, is Y = 0.</p>',
        tooltipCandidates_po: 'leerlingen (advies)'
      }
    };
    function t(key) {
      const lang = L[currentLang] || L.en;
      const modeKey = key + '_' + currentMode;
      return (lang[modeKey] !== undefined ? lang[modeKey] : lang[key]) || L.en[modeKey] || L.en[key] || key;
    }
    function updateMobileModeSpecificUI() {
      var sboBtn = document.getElementById('mobileSboToggle');
      var sboLabel = document.getElementById('mobileSboLabel');
      if (!sboBtn) return;
      if (currentMode === 'po') {
        sboBtn.classList.remove('hidden');
        if (sboLabel) sboLabel.textContent = t('labelShowSbo');
      } else {
        sboBtn.classList.add('hidden');
        if (sboLabel) sboLabel.textContent = t('labelShowVMBO');
      }
    }
    var LANG_DISPLAY = { en: { flag: 'ğŸ‡¬ğŸ‡§', abbr: 'EN' }, zh: { flag: 'ğŸ‡¨ğŸ‡³', abbr: 'CHN' }, nl: { flag: 'ğŸ‡³ğŸ‡±', abbr: 'NL' } };
    function applyLanguage() {
      localStorage.setItem('schools-lang', currentLang);
      var d = LANG_DISPLAY[currentLang] || LANG_DISPLAY.en;
      var langBtnFlag = document.getElementById('langBtnFlag');
      var langBtnAbbr = document.getElementById('langBtnAbbr');
      if (langBtnFlag) langBtnFlag.textContent = d.flag;
      if (langBtnAbbr) langBtnAbbr.textContent = d.abbr;
      var navVO = document.getElementById('navVO');
      if (navVO) navVO.textContent = t('navVO');
      var navPO = document.getElementById('navPO');
      if (navPO) navPO.textContent = t('navPO');
      var countEl = document.getElementById('schoolCount');
      var count = countEl ? countEl.textContent : '0';
      document.title = t('titleMain');
      var titleMain = document.getElementById('titleMain');
      if (titleMain) titleMain.textContent = t('titleMain');
      var subtitleMain = document.getElementById('subtitleMain');
      if (subtitleMain) subtitleMain.innerHTML = t('subtitleBefore') + '<strong id="schoolCount">' + count + '</strong>' + t('subtitleAfter');
      var labelSchoolSearch = document.getElementById('labelSchoolSearch');
      if (labelSchoolSearch) labelSchoolSearch.textContent = t('labelSchoolSearch');
      var schoolSearch = document.getElementById('schoolSearch');
      if (schoolSearch) {
        schoolSearch.placeholder = t('schoolSearchPlaceholderShort');
        schoolSearch.title = t('schoolSearchPlaceholder');
      }
      var schoolSearchHint = document.getElementById('schoolSearchHint');
      if (schoolSearchHint) schoolSearchHint.textContent = t('schoolSearchPlaceholder');
      var labelGemeente = document.getElementById('labelGemeente');
      if (labelGemeente) labelGemeente.textContent = t('labelGemeente');
      var gemeenteFilter = document.getElementById('gemeenteFilter');
      if (gemeenteFilter) {
        gemeenteFilter.placeholder = t('gemeentePlaceholderShort');
        gemeenteFilter.title = t('gemeentePlaceholder');
      }
      var gemeenteFilterHint = document.getElementById('gemeenteFilterHint');
      if (gemeenteFilterHint) gemeenteFilterHint.textContent = t('gemeentePlaceholder');
      var labelShowVMBO = document.getElementById('labelShowVMBO');
      if (labelShowVMBO) labelShowVMBO.textContent = currentMode === 'vo' ? t('labelShowVMBO') : t('labelShowSbo');
      var labelSelectAll = document.getElementById('labelSelectAll');
      if (labelSelectAll) labelSelectAll.textContent = t('labelSelectAll');
      var labelDeselectAll = document.getElementById('labelDeselectAll');
      if (labelDeselectAll) labelDeselectAll.textContent = t('labelDeselectAll');
      var themeToggleBtn = document.getElementById('themeToggle');
      if (themeToggleBtn) themeToggleBtn.title = isDarkTheme() ? t('labelLight') : t('labelDark');
      var shareBtn = document.getElementById('shareBtn');
      if (shareBtn) shareBtn.textContent = t('share');
      var shareCopyBtn = document.getElementById('shareCopyLink');
      if (shareCopyBtn) shareCopyBtn.textContent = t('shareCopyLink');
      var shareDownloadBtn = document.getElementById('shareDownloadPicture');
      if (shareDownloadBtn) shareDownloadBtn.textContent = t('shareDownloadPicture');
      var shareXLink = document.getElementById('shareXLink');
      if (shareXLink) shareXLink.textContent = t('shareToX');
      var shareFbLink = document.getElementById('shareFbLink');
      if (shareFbLink) shareFbLink.textContent = t('shareToFacebook');
      updateShareLinks();
      var excludedTitleText = document.getElementById('excludedTitleText');
      if (excludedTitleText) excludedTitleText.textContent = t('excludedTitle');
      var excludedDesc = document.getElementById('excludedDesc');
      if (excludedDesc) excludedDesc.textContent = t('excludedDesc');
      var algorithmTitleText = document.getElementById('algorithmTitleText');
      if (algorithmTitleText) algorithmTitleText.textContent = t('algorithmTitle');
      var algorithmBody = document.getElementById('algorithmBody');
      if (algorithmBody) {
        var algoHtml = buildAlgorithmBodyFromMeta();
        algorithmBody.innerHTML = algoHtml || t('algorithmBody');
      }
      var disclaimerTitleText = document.getElementById('disclaimerTitleText');
      if (disclaimerTitleText) disclaimerTitleText.textContent = t('disclaimerTitle');
      var disclaimerBody = document.getElementById('disclaimerBody');
      if (disclaimerBody) disclaimerBody.textContent = t('disclaimerBody');
      var contactTitle = document.getElementById('contactTitle');
      if (contactTitle) contactTitle.textContent = t('contactTitle');
      var supportHint = document.getElementById('supportHint');
      if (supportHint) supportHint.textContent = t('supportHint');
      var copyrightText = document.getElementById('copyrightText');
      if (copyrightText) copyrightText.textContent = t('copyrightText');
      if (typeof chart !== 'undefined') {
        var xTitleFromMeta = getAxisTitleFromMeta('x');
        var yTitleFromMeta = getAxisTitleFromMeta('y');
        chart.options.scales.x.title.text = xTitleFromMeta || t('axisXLinear');
        chart.options.scales.y.title.text = yTitleFromMeta || t('axisYLinear');
        chart.update();
      }
      updateMobileModeSpecificUI();
    }
    let points = data.map(d => ({ x: d.X_linear, y: d.Y_linear, label: d.naam, type: d.type, gemeente: d.gemeente, postcode: d.postcode || '', size: d.size, brin: d.BRIN }));

    let selectedGemeenten = new Set();
    var DEFAULT_GEMEENTEN = ["'S-GRAVENHAGE", 'AMSTERDAM', 'UTRECHT', 'ROTTERDAM'];

    function getSelectedCitiesCount() {
      return selectedGemeenten ? selectedGemeenten.size : 0;
    }
    function updateMobileFiltersSummary() {
      var n = getSelectedCitiesCount();
      var label = document.getElementById('mobileFiltersBtnLabel');
      var header = document.getElementById('mobileFiltersHeader');
      var text = 'Cities (' + n + ')';
      if (label) label.textContent = text;
      if (header) header.textContent = text;
    }

    function getShareUrl() {
      var base = window.location.origin + window.location.pathname;
      var q = (document.getElementById('schoolSearch') && document.getElementById('schoolSearch').value || '').trim();
      var g = (document.getElementById('gemeenteFilter') && document.getElementById('gemeenteFilter').value || '').trim();
      var parts = [];
      if (currentMode) parts.push('layer=' + encodeURIComponent(currentMode));
      if (currentLang) parts.push('lang=' + encodeURIComponent(currentLang));
      if (q) parts.push('q=' + encodeURIComponent(q));
      if (g) parts.push('gemeente=' + encodeURIComponent(g));
      // å°†å½“å‰å‹¾é€‰çš„åŸå¸‚é›†åˆç¼–ç åˆ° city= å‚æ•°ï¼Œä¾¿äºåˆ†äº«æ—¶è¿˜åŸç²¾ç¡®åŸå¸‚é€‰æ‹©
      if (selectedGemeenten && selectedGemeenten.size > 0) {
        var cityList = Array.from(selectedGemeenten);
        parts.push('city=' + encodeURIComponent(cityList.join(',')));
      }
      var showVMBOEl = document.getElementById('showVMBO');
      if (showVMBOEl && currentMode === 'po') {
        parts.push('include_sbo=' + (showVMBOEl.checked ? '1' : '0'));
      }
      if (parts.length) base += '?' + parts.join('&');
      return base;
    }
    function updateShareLinks() {
      var url = getShareUrl();
      var shareXLink = document.getElementById('shareXLink');
      if (shareXLink) shareXLink.href = 'https://twitter.com/intent/tweet?url=' + encodeURIComponent(url) + '&text=' + encodeURIComponent(t('titleMain'));
      var shareFbLink = document.getElementById('shareFbLink');
      if (shareFbLink) shareFbLink.href = 'https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(url);
    }
    function applyUrlParams() {
      var params = new URLSearchParams(window.location.search);
      // layer
      var layer = params.get('layer');
      if (layer === 'vo' || layer === 'po') {
        switchMode(layer);
      }
      // language
      var langParam = params.get('lang');
      if (langParam && (L[langParam] || L.en)) {
        currentLang = langParam;
        localStorage.setItem('schools-lang', currentLang);
        applyLanguage();
      }
      // scale=log / scale=linear in URL: ignored; we always use linear (historical link compat)
      // text filters
      var q = params.get('q');
      var searchEl = document.getElementById('schoolSearch');
      if (q != null && searchEl) searchEl.value = q;
      var gemeenteParam = params.get('gemeente');
      if (gemeenteParam != null) {
        var filterEl = document.getElementById('gemeenteFilter');
        if (filterEl) filterEl.value = gemeenteParam;
        // æ–‡æœ¬è¿‡æ»¤æ¡ä»¶å…ˆä½œç”¨äºå¯é€‰åŸå¸‚é›†åˆ
        var listFromFilter = getGemeentenInList();
        selectedGemeenten = new Set(listFromFilter);
      }
      // å…¼å®¹ UI_DESIGN ä¸­ city= å‚æ•°ï¼Œç”¨äºç²¾ç¡®è¿˜åŸå‹¾é€‰çš„åŸå¸‚é›†åˆ
      var cityParam = params.get('city');
      if (cityParam != null && cityParam.trim() !== '') {
        var rawCities = cityParam.split(',').map(function(s) { return s.trim(); }).filter(Boolean);
        var targetSet = new Set(rawCities.map(function(s) { return s.toUpperCase(); }));
        var allList = getGemeentenInList();
        selectedGemeenten = new Set(
          allList.filter(function(name) { return targetSet.has(String(name || '').toUpperCase()); })
        );
      }
      // include_sbo (åªåœ¨ PO æ—¶ç”Ÿæ•ˆ)
      var includeSbo = params.get('include_sbo');
      if (includeSbo != null) {
        var showVMBOEl = document.getElementById('showVMBO');
        if (showVMBOEl && currentMode === 'po') {
          showVMBOEl.checked = includeSbo === '1';
        }
      }
    }

    function getPointsByTextFilter(points) {
      const parts = (document.getElementById('gemeenteFilter').value || '').split(',').map(s => s.trim().toUpperCase()).filter(Boolean);
      if (parts.length === 0) return points;
      return points.filter(p => p.gemeente && parts.some(q => p.gemeente.toUpperCase().includes(q)));
    }
    function getFilteredPoints(points) {
      const byText = getPointsByTextFilter(points);
      /* åªæ˜¾ç¤ºå‹¾é€‰çš„ gemeentenï¼šæœªå‹¾é€‰ä»»ä½•æ—¶æ˜¾ç¤ºä¸ºç©ºï¼Œå›¾ä¾‹ä»…åŒ…å«å½“å‰å‹¾é€‰é¡¹ */
      let result = byText.filter(p => p.gemeente && selectedGemeenten.has(p.gemeente));
      var showVMBOEl = document.getElementById('showVMBO');
      if (showVMBOEl && !showVMBOEl.checked) {
        if (currentMode === 'vo') result = result.filter(function(p) { return p.type !== 'VMBO'; });
        else result = result.filter(function(p) { return p.type !== 'Sbo'; });
      }
      return result;
    }
    function getGemeentenInList() {
      const pts = getPointsByTextFilter(points);
      const set = new Set();
      pts.forEach(p => { if (p.gemeente) set.add(p.gemeente); });
      return Array.from(set).sort();
    }
    function renderGemeenteCheckboxes() {
      const list = getGemeentenInList();
      if (list.length > 0 && selectedGemeenten.size === 0) {
        var defaultSet = new Set(DEFAULT_GEMEENTEN);
        selectedGemeenten = new Set(list.filter(function(g) { return defaultSet.has((g || '').toUpperCase()); }));
        if (selectedGemeenten.size === 0) selectedGemeenten = new Set(list);
      }
      const container = document.getElementById('gemeenteCheckboxes');
      container.innerHTML = '';
      list.forEach(g => {
        const label = document.createElement('label');
        label.className = 'inline-flex items-center gap-2 cursor-pointer text-sm text-slate-600 hover:text-slate-800';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.className = 'gemeente-cb rounded border-slate-300 text-slate-600 focus:ring-slate-400';
        cb.dataset.gemeente = g;
        cb.checked = selectedGemeenten.has(g);
        cb.addEventListener('change', () => {
          if (cb.checked) selectedGemeenten.add(g); else selectedGemeenten.delete(g);
          syncSelectAllDeselectAll();
          refreshChart();
        });
        label.appendChild(cb);
        label.appendChild(document.createTextNode(g));
        container.appendChild(label);
      });
      syncSelectAllDeselectAll();
      updateMobileFiltersSummary();
    }
    function syncSelectAllDeselectAll() {
      const list = getGemeentenInList();
      const allSelected = list.length > 0 && list.every(g => selectedGemeenten.has(g));
      const noneSelected = list.length === 0 || list.every(g => !selectedGemeenten.has(g));
      document.getElementById('selectAll').checked = allSelected;
      document.getElementById('deselectAll').checked = noneSelected;
      updateMobileFiltersSummary();
    }
    function updateChartLabels() {
      const overlay = document.getElementById('chartLabels');
      if (!overlay || !chart || !chart.scales || !chart.scales.x || !chart.scales.y) return;
      const searchEl = document.getElementById('schoolSearch');
      const hasSearch = searchEl && (searchEl.value || '').trim().length > 0;
      if (!hasSearch) {
        overlay.innerHTML = '';
        return;
      }
      const canvas = chart.canvas;
      if (!canvas || !chart.width || !chart.height) return;
      overlay.innerHTML = '';
      var displayW = canvas.clientWidth;
      var displayH = canvas.clientHeight;
      if (!displayW || !displayH) return;
      var scaleX = displayW / chart.width;
      var scaleY = displayH / chart.height;
      if (!isFinite(scaleX) || !isFinite(scaleY)) return;
      const isDark = document.documentElement.classList.contains('dark');
      const textCls = isDark ? 'text-slate-200' : 'text-slate-800';
      const bgCls = isDark ? 'bg-slate-900/95' : 'bg-white/95';
      const borderCls = isDark ? 'border-slate-500' : 'border-slate-300';
      const highlightCls = 'bg-amber-400/60 dark:bg-amber-500/50';
      chart.data.datasets.forEach(function(ds) {
        if (!ds.data) return;
        ds.data.forEach(function(pt) {
          if (!pt.matched || !pt.naam) return;
          const x = chart.scales.x.getPixelForValue(pt.x);
          const y = chart.scales.y.getPixelForValue(pt.y);
          const r = (typeof ds.pointRadius === 'function' ? ds.pointRadius({ raw: pt, dataIndex: 0, datasetIndex: 0, chart: chart }) : (ds.pointRadius || 8)) || 8;
          const labelTop = (y - r - 22) * scaleY;
          const labelLeft = x * scaleX;
          const el = document.createElement('div');
          el.className = 'absolute text-xs font-medium whitespace-nowrap px-2 py-1 rounded border shadow-sm ' + bgCls + ' ' + borderCls + ' ' + textCls;
          el.style.left = (labelLeft) + 'px';
          el.style.top = (labelTop) + 'px';
          el.style.transform = 'translate(-50%, 0)';
          const highlights = pt.nameHighlights || [];
          if (highlights.length === 0) {
            el.textContent = pt.naam;
          } else {
            const name = pt.naam;
            let last = 0;
            highlights.forEach(function(range) {
              if (range[0] > last) {
                const span = document.createElement('span');
                span.textContent = name.slice(last, range[0]);
                el.appendChild(span);
              }
              const hi = document.createElement('span');
              hi.className = 'rounded px-0.5 ' + highlightCls;
              hi.textContent = name.slice(range[0], range[1]);
              el.appendChild(hi);
              last = range[1];
            });
            if (last < name.length) {
              const span = document.createElement('span');
              span.textContent = name.slice(last);
              el.appendChild(span);
            }
          }
          overlay.appendChild(el);
        });
      });
    }
    function setSampleTooltip() {
      if (getSchoolSearchTerms().length > 0) {
        if (chart.tooltip) chart.tooltip.setActiveElements([], { x: 0, y: 0 });
        chart.update();
        return;
      }
      const datasets = chart.data.datasets || [];
      const withData = datasets.map(function(ds, i) { return { i: i, len: (ds.data && ds.data.length) || 0 }; }).filter(function(o) { return o.len > 0; });
      if (withData.length === 0) return;
      const chosen = withData[Math.floor(Math.random() * withData.length)];
      const datasetIndex = chosen.i;
      const dataArr = chart.data.datasets[datasetIndex].data;
      const index = Math.floor(Math.random() * dataArr.length);
      const pt = dataArr[index];
      if (!pt || chart.scales == null || !chart.scales.x || !chart.scales.y) return;
      const px = chart.scales.x.getPixelForValue(pt.x);
      const py = chart.scales.y.getPixelForValue(pt.y);
      if (chart.tooltip && typeof chart.tooltip.setActiveElements === 'function') {
        chart.tooltip.setActiveElements([{ datasetIndex: datasetIndex, index: index }], { x: px, y: py });
        chart.update();
      }
    }
    function refreshChart() {
      const filtered = getFilteredPoints(points);
      var dss = makeDatasets(filtered);
      var terms = getSchoolSearchTerms();
      if (terms.length === 0) {
        legendHighlightGemeenten = null;
      } else {
        legendHighlightGemeenten = new Set();
        for (var di = 0; di < dss.length; di++) {
          var arr = dss[di].data;
          if (arr) for (var k = 0; k < arr.length; k++) if (arr[k] && arr[k].matched) { legendHighlightGemeenten.add(dss[di].label); break; }
        }
      }
      chart.data.datasets = dss;
      document.getElementById('schoolCount').textContent = filtered.length;
      if (filtered.length > 0) {
        const ys = filtered.map(function(p) { return p.y; });
        const minY = Math.min.apply(null, ys);
        const maxY = Math.max.apply(null, ys);
        const range = maxY - minY || 1;
        const pad = range * 0.05;
        chart.options.scales.y.min = Math.min(minY - pad, minY * 0.95);
        chart.options.scales.y.max = maxY * 1.05;
        if (chart.options.scales.y.min < 0 && (currentMode === 'vo' || currentMode === 'po')) chart.options.scales.y.min = 0;
        chart.options.scales.y.afterBuildTicks = undefined;
        chart.options.scales.y.ticks = { stepSize: undefined };
      }
      chart.update();
      updateLegend();
      requestAnimationFrame(function() { updateChartLabels(); setSampleTooltip(); });
    }
    function setChartScaleForMode() {
      var xTitleFromMeta = getAxisTitleFromMeta('x');
      var yTitleFromMeta = getAxisTitleFromMeta('y');
      chart.options.scales.x.title.text = xTitleFromMeta || t('axisXLinear');
      chart.options.scales.y.title.text = yTitleFromMeta || t('axisYLinear');
      if (currentMode === 'po') {
        chart.options.scales.x.min = -5; chart.options.scales.x.max = 105;
        chart.options.scales.x.afterBuildTicks = function(axis) { axis.ticks = [0,10,20,30,40,50,60,70,80,90,100].map(function(v){ return { value: v }; }); };
        chart.options.scales.x.ticks = { stepSize: 10 };
        chart.options.scales.y.min = -50; chart.options.scales.y.max = 1050;
        chart.options.scales.y.afterBuildTicks = function(axis) { axis.ticks = [0,200,400,600,800,1000].map(function(v){ return { value: v }; }); };
        chart.options.scales.y.ticks = { stepSize: 200 };
      } else {
        chart.options.scales.x.min = -5; chart.options.scales.x.max = 105;
        chart.options.scales.x.afterBuildTicks = function(axis) { axis.ticks = [0,10,20,30,40,50,60,70,80,90,100].map(function(v){ return { value: v }; }); };
        chart.options.scales.x.ticks = { stepSize: 10 };
        chart.options.scales.y.min = -5; chart.options.scales.y.max = 105;
        chart.options.scales.y.afterBuildTicks = function(axis) { axis.ticks = [0,10,20,30,40,50,60,70,80,90,100].map(function(v){ return { value: v }; }); };
        chart.options.scales.y.ticks = { stepSize: 10 };
      }
      chart.update();
    }
    function updateNavButtons() {
      document.querySelectorAll('.navSchoolType').forEach(function(btn) {
        const active = btn.getAttribute('data-mode') === currentMode;
        btn.classList.toggle('bg-slate-200', active); btn.classList.toggle('dark:bg-slate-600', active);
        btn.classList.toggle('bg-transparent', !active);
        btn.classList.toggle('text-slate-800', active); btn.classList.toggle('dark:text-slate-100', active);
        btn.classList.toggle('text-slate-600', !active); btn.classList.toggle('dark:text-slate-400', !active);
      });
    }
    function switchMode(mode) {
      if (mode === currentMode) return;
      currentMode = mode;
      localStorage.setItem('schools-mode', mode);
      data = mode === 'vo' ? dataVO : dataPO;
      meta = mode === 'vo' ? metaVO : metaPO;
      points = data.map(d => ({ x: d.X_linear, y: d.Y_linear, label: d.naam, type: d.type, gemeente: d.gemeente, postcode: d.postcode || '', size: d.size, brin: d.BRIN }));
      updateExcludedSection();
      applyLanguage();
      setChartScaleForMode();
      selectedGemeenten = new Set();
      renderGemeenteCheckboxes();
      refreshChart();
      updateNavButtons();
      updateMobileModeSpecificUI();
      updateMobileSboButton();
    }

    /** ç¡®å®šæ€§ hashï¼šgemeente åå­— -> é¢œè‰²ã€‚åŒä¸€åå­—å§‹ç»ˆå¾—åˆ°åŒä¸€é¢œè‰²ã€‚ç›¸ä¼¼åå­—ç”¨é»„é‡‘è§’+ç‹¬ç«‹ S/L æ‹‰å¼€åŒºåˆ†ã€‚ */
    function hashString(s, seed) {
      let h = seed || 0;
      const str = (s || '').toString().toUpperCase();
      for (let i = 0; i < str.length; i++) h = Math.imul(31, h) + str.charCodeAt(i) | 0;
      return Math.abs(h) >>> 0;
    }
    const GOLDEN = 137.508;
    function gemeenteToColor(gemeente) {
      const h = hashString(gemeente);
      const hS = hashString(gemeente, 1);
      const hL = hashString(gemeente, 2);
      const hue = (h * GOLDEN) % 360;
      const sat = 60 + (hS % 35);
      const light = 35 + (hL % 45);
      return `hsla(${hue}, ${sat}%, ${light}%, 0.9)`;
    }
    function gemeenteToBorderColor(gemeente) {
      const h = hashString(gemeente);
      const hS = hashString(gemeente, 1);
      const hL = hashString(gemeente, 2);
      const hue = (h * GOLDEN) % 360;
      const sat = Math.min(85, 60 + (hS % 35) + 10);
      const light = Math.max(18, 35 + (hL % 45) - 22);
      return `hsl(${hue}, ${sat}%, ${light}%)`;
    }

    /** æ ¹æ®å½“å‰å¯è§ç‚¹çš„ size å°†äººæ•°æ˜ å°„ä¸ºåœ†ç‚¹åŠå¾„ï¼ˆçº¦ 4â€“20pxï¼‰ */
    function sizeToRadius(points) {
      const sizes = points.map(p => (p.size != null && p.size > 0) ? p.size : 0).filter(Boolean);
      if (sizes.length === 0) return () => 8;
      const minS = Math.min(...sizes);
      const maxS = Math.max(...sizes);
      const range = maxS - minS || 1;
      return function(size) {
        if (size == null || size <= 0) return 8;
        return Math.round(4 + 14 * (size - minS) / range);
      };
    }
    var legendHighlightGemeenten = null;
    function getSchoolSearchTerms() {
      const raw = (document.getElementById('schoolSearch') && document.getElementById('schoolSearch').value || '').trim();
      if (!raw) return [];
      return raw.split(',').map(s => s.trim().toUpperCase()).filter(Boolean);
    }
    function escapeHtml(s) {
      if (!s) return '';
      var d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }
    function updateLegend() {
      var container = document.getElementById('customLegend');
      if (!container || !chart || !chart.data || !chart.data.datasets) return;
      var datasets = chart.data.datasets;
      container.innerHTML = '';
      for (var i = 0; i < datasets.length; i++) {
        var ds = datasets[i];
        var label = ds.label || '';
        var useColor = legendHighlightGemeenten === null || legendHighlightGemeenten.has(label);
        var boxColor = useColor ? gemeenteToColor(label) : 'rgba(160,160,160,0.6)';
        var textCls = useColor ? 'text-slate-700 dark:text-slate-300' : 'text-slate-400 dark:text-slate-500';
        var item = document.createElement('span');
        item.className = 'inline-flex items-center gap-1.5 text-sm';
        item.innerHTML = '<span class="inline-block w-4 h-3 rounded border border-slate-300 dark:border-slate-500" style="background:' + boxColor + ';"></span><span class="' + textCls + '">' + escapeHtml(label) + '</span>';
        container.appendChild(item);
      }
    }
    function acronymFromName(naam) {
      if (!naam || !String(naam).trim()) return '';
      return String(naam).trim().split(/\s+/).map(w => (w[0] || '').toUpperCase()).join('');
    }
    function pointMatchesSearch(p, searchTerms) {
      if (!searchTerms || searchTerms.length === 0) return true;
      const naam = (p.label || '').toUpperCase();
      const acr = acronymFromName(p.label || '');
      const brin = (p.brin || '').toUpperCase();
      const gemeente = (p.gemeente || '').toUpperCase();
      const postcode = (p.postcode || '').toUpperCase().replace(/\s/g, '');
      return searchTerms.some(term => {
        const termNorm = term.replace(/\s/g, '');
        return naam.includes(term) || (acr && acr.includes(termNorm)) || brin.includes(term) || gemeente.includes(term) || postcode.includes(termNorm);
      });
    }
    function getNameHighlights(label, searchTerms) {
      if (!label || !searchTerms || searchTerms.length === 0) return [];
      const upper = label.toUpperCase();
      const ranges = [];
      for (const term of searchTerms) {
        let idx = 0;
        while (true) {
          const i = upper.indexOf(term, idx);
          if (i === -1) break;
          ranges.push([i, i + term.length]);
          idx = i + 1;
        }
      }
      ranges.sort((a, b) => a[0] - b[0]);
      const merged = [];
      for (const [s, e] of ranges) {
        if (merged.length && s <= merged[merged.length - 1][1]) {
          merged[merged.length - 1][1] = Math.max(merged[merged.length - 1][1], e);
        } else merged.push([s, e]);
      }
      return merged;
    }
    function makeDatasets(points) {
      const radiusFn = sizeToRadius(points);
      const searchTerms = getSchoolSearchTerms();
      const byGemeente = {};
      points.forEach(p => {
        const g = p.gemeente || '(æœªçŸ¥)';
        if (!byGemeente[g]) byGemeente[g] = [];
        const matched = pointMatchesSearch(p, searchTerms);
        const nameHighlights = getNameHighlights(p.label, searchTerms);
        byGemeente[g].push({
          x: p.x, y: p.y, naam: p.label, type: p.type, postcode: p.postcode || '',
          r: radiusFn(p.size),
          size: p.size,
          matched: matched,
          nameHighlights: nameHighlights
        });
      });
      const gemeenten = Object.keys(byGemeente).sort();
      return gemeenten.map(g => {
        const bgColor = gemeenteToColor(g);
        return {
          label: g,
          data: byGemeente[g],
          pointRadius: function(ctx) {
            const r = ctx.raw.r != null ? ctx.raw.r : 8;
            const chartW = (ctx.chart && ctx.chart.width) || 800;
            const scale = Math.min(1, chartW / 800);
            const baseR = Math.max(1, Math.round(r * scale));
            return ctx.raw.matched ? Math.max(baseR, baseR * 1.4 + 2) : baseR;
          },
          backgroundColor: function(ctx) {
            if (ctx.raw.matched) return bgColor;
            return 'rgba(180,180,180,0.28)';
          },
          borderColor: function(ctx) {
            if (ctx.raw.matched) return bgColor;
            return 'rgba(120,120,120,0.45)';
          },
          borderWidth: 1
        };
      });
    }

    function updateTooltipScale() {
      var scale = (window.visualViewport && typeof window.visualViewport.scale === 'number') ? window.visualViewport.scale : 1;
      var s = scale > 0 ? 1 / scale : 1;
      document.querySelectorAll('.chartjs-tooltip').forEach(function(el) {
        el.style.transform = 'scale(' + s + ')';
      });
    }
    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', updateTooltipScale);
      window.visualViewport.addEventListener('scroll', updateTooltipScale);
    }

    const chart = new Chart(document.getElementById('chart'), {
      type: 'scatter',
      data: { datasets: [] },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        aspectRatio: 4/3,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(ctx) {
                const p = ctx.raw;
                const gemeente = ctx.dataset.label || '';
                const name = p.naam || '';
                const line1 = (gemeente ? gemeente + ' Â· ' : '') + name;
                const lines = [line1];
                if (p.postcode) lines.push((t('tooltipPostcode') || 'Postcode') + ': ' + p.postcode);
                var sizeMetricLabel = null;
                if (meta && meta.axes && meta.axes.size && meta.axes.size.metric_id) {
                  var mSize = resolveMetricFromMeta(meta.axes.size.metric_id);
                  if (mSize) {
                    sizeMetricLabel = mSize.short || mSize.label || meta.axes.size.metric_id;
                  }
                }
                var sizeLabel = sizeMetricLabel || t('tooltipCandidates');
                lines.push(
                  '(' +
                  p.x.toFixed(2) +
                  ', ' +
                  p.y.toFixed(2) +
                  ') ' +
                  sizeLabel +
                  ': ' +
                  (p.size != null && p.size > 0 ? p.size : 'â€”')
                );
                return lines;
              },
              afterBody: function() {
                // tooltip å‡ºç°æ—¶ï¼Œæ¸…ç©ºåç§° labelï¼Œé¿å…é®æŒ¡é»‘è‰² tooltip
                var overlay = document.getElementById('chartLabels');
                if (overlay) overlay.innerHTML = '';
                setTimeout(updateTooltipScale, 0);
              }
            }
          },
        },
        scales: {
          x: {
            title: { display: true, text: 'VWO share (%)' },
            min: -5,
            max: 105,
            grace: '0%',
            afterBuildTicks: function(axis) { axis.ticks = [0,10,20,30,40,50,60,70,80,90,100].map(function(v){ return { value: v }; }); },
            ticks: { stepSize: 10 }
          },
          y: {
            title: { display: true, text: 'Science share (%)' },
            min: -5,
            max: 105,
            grace: '0%',
            afterBuildTicks: function(axis) { axis.ticks = [0,10,20,30,40,50,60,70,80,90,100].map(function(v){ return { value: v }; }); },
            ticks: { stepSize: 10 }
          }
        }
      },
    });

    // å½“é¼ æ ‡ç§»å¼€å¯¼è‡´ tooltip æ¶ˆå¤±æ—¶ï¼Œå¦‚æœä»æœ‰æœç´¢è¯ï¼Œåˆ™æ¢å¤åç§° label
    (function attachHoverLabelRestore() {
      var canvas = chart && chart.canvas;
      if (!canvas) return;
      function maybeRestoreLabels() {
        var terms = getSchoolSearchTerms();
        if (!terms || terms.length === 0) return;
        try {
          if (chart.tooltip && typeof chart.tooltip.getActiveElements === 'function') {
            var active = chart.tooltip.getActiveElements();
            if (active && active.length > 0) return;
          }
        } catch (e) {
          // ignore
        }
        updateChartLabels();
      }
      canvas.addEventListener('mousemove', maybeRestoreLabels);
      canvas.addEventListener('mouseleave', maybeRestoreLabels);
    })();

    function scheduleUpdateChartLabels() {
      requestAnimationFrame(function() {
        if (chart && typeof chart.update === 'function') chart.update('resize');
        requestAnimationFrame(function() { updateChartLabels(); });
      });
    }
    window.addEventListener('resize', scheduleUpdateChartLabels);
    window.addEventListener('orientationchange', function() {
      setTimeout(scheduleUpdateChartLabels, 150);
    });
    var chartContainer = document.getElementById('chart') && document.getElementById('chart').parentElement;
    if (chartContainer && typeof ResizeObserver !== 'undefined') {
      var resizeObserver = new ResizeObserver(function() { scheduleUpdateChartLabels(); });
      resizeObserver.observe(chartContainer);
    }

    document.getElementById('selectAll').addEventListener('change', function() {
      if (this.checked) {
        const list = getGemeentenInList();
        selectedGemeenten = new Set(list);
        document.getElementById('deselectAll').checked = false;
        document.querySelectorAll('.gemeente-cb').forEach(cb => { cb.checked = true; });
      } else {
        selectedGemeenten = new Set();
        document.getElementById('deselectAll').checked = true;
        document.querySelectorAll('.gemeente-cb').forEach(cb => { cb.checked = false; });
      }
      syncSelectAllDeselectAll();
      refreshChart();
      updateMobileFiltersSummary();
    });
    document.getElementById('deselectAll').addEventListener('change', function() {
      if (this.checked) {
        selectedGemeenten = new Set();
        document.getElementById('selectAll').checked = false;
        document.querySelectorAll('.gemeente-cb').forEach(cb => { cb.checked = false; });
      } else {
        const list = getGemeentenInList();
        selectedGemeenten = new Set(list);
        document.getElementById('selectAll').checked = true;
        document.querySelectorAll('.gemeente-cb').forEach(cb => { cb.checked = true; });
      }
      syncSelectAllDeselectAll();
      refreshChart();
      updateMobileFiltersSummary();
    });

    var schoolSearchInput = document.getElementById('schoolSearch');
    var schoolSearchWrap = document.getElementById('schoolSearchWrap');
    schoolSearchInput.addEventListener('input', function() { refreshChart(); updateShareLinks(); });
    schoolSearchInput.addEventListener('change', function() { refreshChart(); updateShareLinks(); });
    schoolSearchInput.addEventListener('focus', function() { if (schoolSearchWrap) schoolSearchWrap.classList.add('show-hint'); });
    schoolSearchInput.addEventListener('blur', function() { if (schoolSearchWrap) schoolSearchWrap.classList.remove('show-hint'); });
    var mobileSchoolSearch = document.getElementById('mobileSchoolSearch');
    if (mobileSchoolSearch && schoolSearchInput) {
      mobileSchoolSearch.addEventListener('input', function() {
        if (schoolSearchInput.value !== mobileSchoolSearch.value) {
          schoolSearchInput.value = mobileSchoolSearch.value;
          var ev = new Event('input', { bubbles: true });
          schoolSearchInput.dispatchEvent(ev);
        }
      });
      schoolSearchInput.addEventListener('input', function() {
        if (mobileSchoolSearch.value !== schoolSearchInput.value) {
          mobileSchoolSearch.value = schoolSearchInput.value;
        }
      });
    }

    var gemeenteFilterInput = document.getElementById('gemeenteFilter');
    var gemeenteFilterWrap = document.getElementById('gemeenteFilterWrap');
    gemeenteFilterInput.addEventListener('input', function() {
      renderGemeenteCheckboxes();
      refreshChart();
      updateShareLinks();
    });
    gemeenteFilterInput.addEventListener('change', function() {
      renderGemeenteCheckboxes();
      refreshChart();
      updateShareLinks();
    });
    gemeenteFilterInput.addEventListener('focus', function() { if (gemeenteFilterWrap) gemeenteFilterWrap.classList.add('show-hint'); });
    gemeenteFilterInput.addEventListener('blur', function() { if (gemeenteFilterWrap) gemeenteFilterWrap.classList.remove('show-hint'); });

    var showVMBOEl = document.getElementById('showVMBO');
    if (showVMBOEl) showVMBOEl.addEventListener('change', function() {
      refreshChart();
      // åŒæ­¥ mobile Sbo å¼€å…³å¤–è§‚
      updateMobileSboButton();
    });
    var mobileSboToggle = document.getElementById('mobileSboToggle');
    function updateMobileSboButton() {
      if (!mobileSboToggle || !showVMBOEl) return;
      var checked = !!showVMBOEl.checked;
      mobileSboToggle.setAttribute('aria-pressed', checked ? 'true' : 'false');
      if (checked) {
        mobileSboToggle.classList.add('bg-emerald-500', 'text-white', 'border-emerald-500');
      } else {
        mobileSboToggle.classList.remove('bg-emerald-500', 'text-white', 'border-emerald-500');
      }
    }
    if (mobileSboToggle && showVMBOEl) {
      mobileSboToggle.addEventListener('click', function() {
        showVMBOEl.checked = !showVMBOEl.checked;
        var ev = new Event('change', { bubbles: true });
        showVMBOEl.dispatchEvent(ev);
        updateMobileSboButton();
      });
      updateMobileSboButton();
    }

    var langBtn = document.getElementById('langBtn');
    var langWrap = document.getElementById('langWrap');
    if (langBtn && langWrap) {
      langBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        langWrap.classList.toggle('open');
        langBtn.setAttribute('aria-expanded', langWrap.classList.contains('open'));
      });
    }
    document.addEventListener('click', function() {
      document.getElementById('shareWrap').classList.remove('open');
      if (langWrap) { langWrap.classList.remove('open'); if (langBtn) langBtn.setAttribute('aria-expanded', 'false'); }
    });
    if (langWrap) langWrap.addEventListener('click', function(e) { e.stopPropagation(); });
    document.querySelectorAll('.lang-option').forEach(function(btn) {
      btn.addEventListener('click', function() {
        currentLang = this.getAttribute('data-lang');
        localStorage.setItem('schools-lang', currentLang);
        applyLanguage();
        if (langWrap) langWrap.classList.remove('open');
        if (langBtn) langBtn.setAttribute('aria-expanded', 'false');
      });
    });
    currentLang = localStorage.getItem('schools-lang') || 'en';
    applyLanguage();

    function isDarkTheme() { return document.documentElement.classList.contains('dark'); }
    function updateChartTheme(dark) {
      var grid = dark ? '#475569' : '#e2e8f0';
      var text = dark ? '#e2e8f0' : '#334155';
      var tick = dark ? '#94a3b8' : '#64748b';
      if (chart && chart.options && chart.options.scales) {
        chart.options.scales.x.grid.color = grid;
        chart.options.scales.x.ticks.color = tick;
        chart.options.scales.x.title.color = text;
        chart.options.scales.y.grid.color = grid;
        chart.options.scales.y.ticks.color = tick;
        chart.options.scales.y.title.color = text;
        chart.update();
      }
    }
    function applyTheme(dark) {
      document.documentElement.classList.toggle('dark', dark);
      localStorage.setItem('theme', dark ? 'dark' : 'light');
      updateChartTheme(dark);
      requestAnimationFrame(function() { updateChartLabels(); });
      var themeToggleBtn = document.getElementById('themeToggle');
      if (themeToggleBtn) themeToggleBtn.title = dark ? t('labelLight') : t('labelDark');
    }
    document.getElementById('themeToggle').addEventListener('click', function() { applyTheme(!isDarkTheme()); });
    applyTheme(isDarkTheme());

    document.getElementById('shareBtn').addEventListener('click', function(e) {
      e.stopPropagation();
      document.getElementById('shareWrap').classList.toggle('open');
    });
    document.addEventListener('click', function() { document.getElementById('shareWrap').classList.remove('open'); });
    document.getElementById('shareWrap').addEventListener('click', function(e) { e.stopPropagation(); });
    document.getElementById('shareCopyLink').addEventListener('click', function(e) {
      e.preventDefault();
      var url = getShareUrl();
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(url).then(function() {
          var btn = document.getElementById('shareCopyLink');
          var orig = btn.textContent;
          btn.textContent = t('shareCopied');
          setTimeout(function() { btn.textContent = orig; }, 1500);
        }).catch(function() { window.prompt(t('shareCopyLink') || 'Copy link', url); });
      } else {
        window.prompt(t('shareCopyLink') || 'Copy link', url);
      }
    });
    document.getElementById('shareDownloadPicture').addEventListener('click', function(e) {
      e.preventDefault();
      var btn = document.getElementById('shareDownloadPicture');
      var origText = btn.textContent;
      btn.textContent = typeof t === 'function' ? t('shareDownloading') : 'Generatingâ€¦';
      btn.disabled = true;
      var el = document.getElementById('chartWrap');
      if (!el || typeof html2canvas === 'undefined') {
        btn.textContent = origText;
        btn.disabled = false;
        return;
      }
      html2canvas(el, { scale: 2, logging: false, backgroundColor: null }).then(function(canvas) {
        var link = document.createElement('a');
        link.download = 'schools-map.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
        btn.textContent = origText;
        btn.disabled = false;
      }).catch(function() {
        btn.textContent = origText;
        btn.disabled = false;
      });
    });

    // Mobile Filters bottom sheet
    (function setupMobileFiltersSheet() {
      var btn = document.getElementById('mobileFiltersBtn');
      var sheet = document.getElementById('mobileFiltersSheet');
      var backdrop = document.getElementById('mobileFiltersBackdrop');
      var panel = document.getElementById('mobileFiltersPanel');
      var content = document.getElementById('mobileFiltersContent');
      var closeBtn = document.getElementById('mobileFiltersClose');
      var gemeenteList = document.getElementById('gemeenteList');
      if (!btn || !sheet || !backdrop || !panel || !content || !gemeenteList) return;
      var originalParent = gemeenteList.parentElement;
      var placeholder = document.createElement('div');
      originalParent.insertBefore(placeholder, gemeenteList.nextSibling);
      var open = false;
      function openSheet() {
        if (open) return;
        open = true;
        sheet.classList.remove('pointer-events-none');
        backdrop.classList.add('opacity-100');
        panel.classList.remove('translate-y-full');
        content.appendChild(gemeenteList);
      }
      function closeSheet() {
        if (!open) return;
        open = false;
        sheet.classList.add('pointer-events-none');
        backdrop.classList.remove('opacity-100');
        panel.classList.add('translate-y-full');
        if (placeholder.parentElement) {
          originalParent.insertBefore(gemeenteList, placeholder);
        }
      }
      btn.addEventListener('click', function() { openSheet(); });
      closeBtn && closeBtn.addEventListener('click', function() { closeSheet(); });
      backdrop.addEventListener('click', function() { closeSheet(); });
      // åˆå§‹åŒæ­¥ä¸€æ¬¡æ‘˜è¦
      updateMobileFiltersSummary();
    })();
    document.getElementById('navVO').addEventListener('click', function() { switchMode('vo'); });
    document.getElementById('navPO').addEventListener('click', function() { switchMode('po'); });
    updateExcludedSection();
    updateNavButtons();
    setChartScaleForMode();
    applyUrlParams();
    renderGemeenteCheckboxes();
    refreshChart();
    updateShareLinks();
  </script>
</body>
</html>
